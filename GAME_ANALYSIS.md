# Bang! Online — Анализ базы данных игры и улучшений

## 1. Обзор архитектуры данных

Игра **не использует постоянную базу данных**. Всё состояние хранится в памяти через
синглтон `RoomManager`, зарегистрированный в контейнере DI ASP.NET Core. `RoomManager`
владеет несколькими экземплярами `GameState`, по одному на комнату. Это означает:

- Состояние игры теряется при перезапуске сервера.
- Поддерживаются **несколько параллельных игровых комнат**, каждая с уникальным 4-символьным
  кодом (например, `A3K9`).
- Статистика игроков, история матчей и прогрессия не сохраняются.
- **Переподключение поддерживается** через `localStorage`. `playerId` и
  `bangRoomCode` сохраняются при входе и автоматически восстанавливаются при перезагрузке
  страницы через эндпоинт `/api/reconnect`.

### Управление комнатами

| Структура | Тип | Назначение |
| --- | --- | --- |
| `RoomManager._rooms` | `Dictionary<string, GameState>` | Все комнаты, ключ — 4-символьный код |
| `RoomManager._playerRoomMap` | `Dictionary<string, string>` | Сопоставление ID игрока и кода комнаты |

Коды комнат используют однозначные символы (без `0/O/1/I`). Пустые комнаты
автоматически удаляются после выхода последнего игрока/зрителя.

### Внутренние структуры данных в комнате

| Структура | Тип | Назначение |
| --- | --- | --- |
| `_players` | `Dictionary<string, PlayerState>` | Все игроки, ключ — GUID |
| `_spectators` | `HashSet<string>` | ID зрителей |
| `_spectatorNames` | `Dictionary<string, string>` | Сопоставление ID зрителя и отображаемого имени |
| `_turnOrder` | `List<string>` | Порядок хода (ID игроков) |
| `_drawPile` | `Stack<Card>` | Оставшиеся карты для добора |
| `_discardPile` | `List<Card>` | Сыгранные/сброшенные карты |
| `_eventLog` | `List<string>` | Последние 20 игровых событий (прокручиваемый список) |
| `_chatLog` | `List<string>` | Последние 30 сообщений чата (отдельно от событий) |

Каждый `PlayerState` содержит `List<Card> InPlay` для экипированных синих/оружейных карт,
а также список `Hand`.

### Журнал событий и чат

Игровые события и сообщения чата хранятся в **разных списках**. Журнал событий
сохраняет последние 20 записей, а чат — последние 30. Оба отображаются
в интерфейсе как прокручиваемые списки, с подсветкой последнего события.
Зрители могут писать в чат (сообщения помечаются префиксом `[Зритель]`).

## 2. Анализ базы карт

### Состав колоды (80 карт всего)

Каждая карта имеет **масть** (Пики, Черви, Бубны, Трефы) и **значение**
(2–A), которые назначаются случайно при сборке колоды. Они используются
в механике проверки «потяните!» (Бочка, Динамит, Тюрьма).

| Карта | Кол-во | % от колоды | Категория | Примечания |
| --- | --- | --- | --- | --- |
| Бах! | 22 | 27.5% | Коричневая | Основная атакующая карта |
| Мимо! | 12 | 15.0% | Коричневая | Основная защитная карта |
| Пиво | 6 | 7.5% | Коричневая | Отключена при <=2 игроках |
| Дилижанс | 4 | 5.0% | Коричневая | Добор 2 карт |
| Кэт Балу | 4 | 5.0% | Коричневая | Цель — рука или снаряжение |
| Паника! | 4 | 5.0% | Коричневая | Дистанция 1; цель — рука или снаряжение |
| Дуэль | 3 | 3.8% | Коричневая | По очереди сбрасываются Бах! |
| Магазин | 3 | 3.8% | Коричневая | Открыть N карт, каждый берёт одну |
| Гатлинг | 2 | 2.5% | Коричневая | Бьёт всех остальных игроков |
| Индейцы! | 2 | 2.5% | Коричневая | Каждый сбрасывает Бах! или получает 1 урон |
| Салун | 2 | 2.5% | Коричневая | Все живые игроки лечатся на 1 ОЗ |
| Уэллс Фарго | 2 | 2.5% | Коричневая | Добор 3 карт |
| Скофилд | 3 | 3.8% | Оружие | Дальность 2 |
| Вулканик | 2 | 2.5% | Оружие | Дальность 1, безлимитные Бах! |
| Ремингтон | 1 | 1.3% | Оружие | Дальность 3 |
| Карабин | 1 | 1.3% | Оружие | Дальность 4 |
| Винчестер | 1 | 1.3% | Оружие | Дальность 5 |
| Бочка | 2 | 2.5% | Синяя | «Потяните!» — червы = уклонение |
| Мустанг | 2 | 2.5% | Синяя | Дистанция до вас +1 |
| Прицел | 1 | 1.3% | Синяя | Дистанция до других -1 |
| Тюрьма | 1 | 1.3% | Синяя | «Потяните!» в начале хода — червы = побег, иначе пропуск хода |
| Динамит | 1 | 1.3% | Синяя | «Потяните!» в начале хода — пики 2–9 = взрыв (3 урона), иначе передаётся |

### Система масти/значения («Потяните!»)

Механика «потяните!» открывает верхнюю карту колоды, проверяет масть и значение,
затем сбрасывает её. Используется для:

- **Бочка**: червы = выстрел отражён.
- **Динамит**: пики 2–9 = взрыв на 3 урона. Иначе передаётся по часовой стрелке.
- **Тюрьма**: червы = побег и нормальная игра. Иначе ход пропускается.
- **Лаки Дьюк**: вытягивает 2 карты для любой проверки и автоматически выбирает лучший результат.

## 3. Анализ базы персонажей

### Способности персонажей (всего 14 уникальных)

| Персонаж | ОЗ | Способность | Примечания |
| --- | --- | --- | --- |
| Лаки Дьюк | 4 | «Потяните!» открывает 2 карты, выбирается лучший результат | Пассивная; влияет на Бочку, Динамит, Тюрьму |
| Слэб Убийца | 4 | Бах! наносит 2 урона | Пассивная |
| Эль Гринго | 3 | Тянет из руки атакующего при получении урона | Пассивная, за каждый урон |
| Сьюзи Лафайет | 4 | Добирает 1 карту, когда рука пустеет | Триггер после любого расхода карт |
| Роуз Дулан | 4 | Встроенный Прицел (дистанция -1) | Пассивная |
| Джесси Джонс | 4 | Первая карта берётся из руки выбранного игрока | Требует выбора в фазе добора |
| Барт Кэссиди | 4 | Добирает 1 карту из колоды при уроне | Пассивная, за каждый урон |
| Пол Регрет | 3 | Встроенный Мустанг (дистанция +1) | Пассивная |
| Каламити Джанет | 4 | Бах! <-> Мимо! взаимозаменяемы | Работает в атаке и защите |
| Кит Карлсон | 4 | Посмотреть 3 верхние карты, оставить 2, 1 вернуть | Требует выбора в фазе добора |
| Уилли Кид | 4 | Безлимитные Бах! за ход | Пассивная |
| Сид Кетчум | 4 | Сбросьте 2 карты, чтобы восстановить 1 ОЗ | Активная способность через /api/ability |
| Валчер Сэм | 4 | Забирает все карты выбывших игроков | Пассивная при смерти других |
| Педро Рамирес | 4 | Первая карта берётся из сброса | Автоматически в фазе добора |

## 4. Игровая логика

### Последовательность начала хода

Каждый ход идёт в таком порядке:

1. **Проверка Динамита** — если у игрока есть Динамит в игре, выполняется проверка.
   Пики 2–9 взрывают на 3 урона (Динамит сбрасывается). Иначе Динамит
   передаётся следующему живому игроку по часовой стрелке. Если взрыв убивает
   игрока, ход переходит к следующему игроку (он также делает проверки Динамита/Тюрьмы).
2. **Проверка Тюрьмы** — если у игрока есть Тюрьма, выполняется проверка. Червы
   означают побег (Тюрьма сбрасывается, игра продолжается). Иначе ход полностью
   пропускается и переходит к следующему игроку.
3. **Фаза добора** — добор карт в зависимости от персонажа (Джесси Джонс, Кит Карлсон,
   Педро Рамирес или стандартный добор 2).
4. **Фаза игры** — разыгрывание карт, использование способностей и т.д.
5. **Фаза сброса** — если рука превышает ОЗ, сброс до лимита.

### Логика комнат и зрителей

- **Вход в комнату** во время игры (или когда комната заполнена) добавляет
  игрока как **зрителя**. Зрители видят состояние игры (карты игроков скрыты),
  могут писать в чат (префикс `[Зритель]`), но не могут играть карты, начинать
  игру, завершать ход или использовать способности.
- **Выход в середине игры** устраняет игрока: его карты сбрасываются, зависшие
  действия очищаются, и ход передаётся, если это был его ход.
- **Новая игра** повышает зрителей до игроков (до 6). Остальные остаются зрителями.
- **Пустые комнаты** автоматически удаляются после ухода последнего человека.

### Дополнительные заметки

1. **Порядок хода — алфавитный** (`Program.cs`), а не по рассадке. Для упрощённой
   версии это допустимо, но стоит помнить об этом.

### Граничные случаи победы

- Если Шериф погиб и живых Бандитов нет, но есть Ренегат, код проверяет
  `alivePlayers.Count == 1 && renegadeAlive` — это корректно.
- Однако если Шериф погиб, а Бандиты и Ренегат погибли одновременно (например, от Гатлинга),
  сообщение говорит «Бандиты победили после падения Шерифа», хотя Бандитов нет.
  Это формально соответствует правилам, но сообщение может сбивать с толку.

## 5. Фронтенд / UX

### Реализовано

- **Панель лобби** — ввод имени, затем создание или вход в комнату по коду. Список
  комнат обновляется каждые 3 секунды и показывает количество игроков/зрителей
  и статус игры.
- **Несколько игровых комнат** — у каждой комнаты есть уникальный 4-символьный код,
  показанный бейджем в заголовке панели игры.
- **Кнопка выхода** — возвращает в лобби; уход во время игры устраняет игрока
  и очищает зависшие действия.
- **Режим зрителя** — синяя плашка («Вы наблюдаете за игрой»), кнопки действий
  отключены, рука пустая. Зрители могут писать в чат и видеть журнал событий.
- **Журнал событий** — прокручиваемый список последних 20 событий, с подсветкой
  последнего события.
- **Чат отделён от событий игры** — отдельный список сообщений над полем ввода,
  независимый от журнала событий.
- **Опрос каждые 1 секунду** — достаточно отзывчиво для казуальной игры.
- **Переподключение через localStorage** — `playerId` и `bangRoomCode` сохраняются
  при входе и автоматически восстанавливаются при перезагрузке через `/api/reconnect`.
  При неудаче пользователь возвращается в лобби.
- **Кнопка «Новая игра»** — появляется после окончания игры, вызывает `/api/newgame`.
  Перед запуском повышает зрителей до игроков.
- **Отображение масти/значения** — каждая карта в руке, экипировке и оверлеях
  показывает символ масти и значение (например, `7`пика, `K`черви). Черви/Бубны
  отображаются красным, Пики/Трефы — серым.
- **Исправление отображения арт-иллюстраций** — изображения используют
  `object-fit: contain` с `max-height: 260px`, чтобы весь арт был виден без обрезки.

### Оставшиеся проблемы

1. **Нет анимации/уведомления раскрытия роли** при смерти игрока.
2. **Нет визуальной обратной связи** на успешный розыгрыш карты — карта просто исчезает.
3. Рассмотреть **WebSocket/SSE** для мгновенных обновлений вместо опроса.

## 6. Приоритетные предложения по улучшению

### Завершено

| # | Улучшение | Статус |
| --- | --- | --- |
| 1 | **Журнал событий** (последние 20, прокрутка) | Сделано |
| 2 | **Разделение чата и событий игры** | Сделано |
| 3 | **Поддержка переподключения** (localStorage + /api/reconnect) | Сделано |
| 4 | **Кнопка «Новая игра»** после окончания | Сделано |
| 5 | **Карта «Тюрьма»** с проверкой «потяните!» в начале хода | Сделано |
| 6 | **Карта «Динамит»** с проверкой «потяните!», передачей и взрывом | Сделано |
| 7 | **Система масти/значения** и «потяните!» для Бочки/Динамита/Тюрьмы | Сделано |
| 8 | **Снижение частоты опроса** с 4с до 1с | Сделано |
| 9 | **Несколько комнат** с RoomManager и кодами комнат | Сделано |
| 10 | **Режим зрителя** для игроков, подключившихся в середине/при заполнении | Сделано |
| 11 | **Выход/возврат** с устранением и возвратом в лобби | Сделано |
| 12 | **Исправление отображения карт** (арт целиком, без обрезки) | Сделано |

### В работе

| # | Улучшение | Влияние |
| --- | --- | --- |
| 1 | **Переход на WebSockets или SSE** для обновлений в реальном времени | Убирает задержки опроса |
| 2 | **Добавить сохранение** (SQLite или JSON) для истории игр | Позволит статистику и повторы матчей |
| 3 | **Анимация раскрытия роли** при смерти игрока | Визуальный полиш |
| 4 | **Обратная связь на розыгрыш карты** (анимация или вспышка) | Визуальный полиш |

## 7. API эндпоинты

### Управление комнатами

| Метод | Эндпоинт | Тело | Описание |
| --- | --- | --- | --- |
| POST | `/api/room/create` | -- | Создаёт новую комнату, возвращает `{ roomCode }` |
| GET | `/api/rooms` | -- | Список комнат с количеством игроков/зрителей и статусом |
| POST | `/api/join` | `{ name, roomCode }` | Вход в комнату (игрок или зритель) |
| POST | `/api/leave` | `{ playerId }` | Покинуть текущую комнату |

### Игровой процесс

| Метод | Эндпоинт | Тело | Описание |
| --- | --- | --- | --- |
| POST | `/api/start` | `{ playerId }` | Запускает игру (зрителям запрещено) |
| POST | `/api/play` | `{ playerId, cardIndex, targetId? }` | Сыграть карту из руки |
| POST | `/api/respond` | `{ playerId, responseType, cardIndex?, targetId? }` | Ответить на действие |
| POST | `/api/end` | `{ playerId }` | Завершить текущий ход |
| POST | `/api/chat` | `{ playerId, text }` | Отправить сообщение (зрителям разрешено) |
| POST | `/api/ability` | `{ playerId, cardIndices }` | Использовать способность (Сид Кетчум) |
| POST | `/api/newgame` | `{ playerId }` | Сбросить игру (повышает зрителей) |
| GET | `/api/reconnect` | `?playerId=` | Переподключение и возврат состояния |
| GET | `/api/state` | `?playerId=` | Опрос текущего состояния |

Все игровые эндпоинты ищут комнату через `RoomManager.GetRoomByPlayer()` и
блокируют игровые действия для зрителей (кроме чата и новой игры).

## 8. Итоги

Игра полностью реализует оригинальный набор карт Bang!: все 80 карт с мастью/значением,
все 14 персонажей с уникальными способностями и полная механика «потяните!» для Бочки,
Динамита и Тюрьмы.

**Основные механики:** система дистанции/дальности использует круговую рассадку,
дальность оружия, Мустанг, Прицел и модификаторы персонажей. **Экипировка (синие карты)**
остаётся в игре — Бочка использует «потяните!» (черви = уклонение), оружие задаёт дальность,
Мустанг и Прицел меняют дистанцию, **Тюрьма** пропускает ход, если не вытянуты червы,
а **Динамит** передаётся по часовой стрелке и взрывается на пиках 2–9, нанося 3 урона.
**Кэт Балу и Паника!** могут нацеливаться на экипировку или руку. **Карты мёртвых игроков**
обрабатываются корректно (сбрасываются или забираются Валчером Сэмом, штраф Шерифа за убийство
помощника). **Лаки Дьюк** тянет 2 карты для любой проверки и автоматически выбирает лучший
результат. **Роли раскрываются при смерти**, **Пиво отключено в 1v1**, и **самоцеливание заблокировано**.

**Мультиплеерная инфраструктура:** **несколько комнат** с 4-символьными кодами,
управляемых синглтоном `RoomManager`. Игроки, подключающиеся во время игры или в заполненную
комнату, становятся **зрителями**, которые могут смотреть и писать в чат, но не играть.
**Выход в середине игры** устраняет игрока и очищает зависшие действия.
**Зрители повышаются до игроков** при начале новой игры (до 6). Пустые комнаты удаляются
автоматически.

**Качество жизни:** журнал событий (прокрутка, последние 20), отдельный чат (последние 30),
переподключение через localStorage (с кодом комнаты), лобби со списком комнат, кнопка
«Новая игра», опрос каждые 1 секунду, отображение масти/значения на всех картах и
полное отображение арт-иллюстраций без обрезки.

**Оставшиеся улучшения:** WebSocket/SSE для мгновенных обновлений, сохранение истории,
визуальный полиш (анимации смерти, обратная связь на розыгрыш карты).
